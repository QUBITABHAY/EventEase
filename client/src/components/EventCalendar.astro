---
// EventCalendar.astro - Google Calendar style event calendar
---

<div class="bg-white shadow-lg border border-gray-200 h-full">
    <!-- Calendar Header -->
    <div class="border-b border-gray-200 p-4 bg-gray-50">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-4">
                <h2 class="text-2xl font-black text-gray-900">
                    <span id="current-month">December</span>
                    <span id="current-year">2025</span>
                </h2>
            </div>
            <div class="flex items-center gap-2">
                <button
                    id="prev-month"
                    class="px-4 py-2 bg-white border border-gray-300 hover:bg-gray-50 transition-colors font-semibold text-gray-700"
                >
                    ‹ Prev
                </button>
                <button
                    id="today-btn"
                    class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 transition-colors font-semibold"
                >
                    Today
                </button>
                <button
                    id="next-month"
                    class="px-4 py-2 bg-white border border-gray-300 hover:bg-gray-50 transition-colors font-semibold text-gray-700"
                >
                    Next ›
                </button>
            </div>
        </div>

        <!-- View Toggle -->
        <div class="flex gap-2">
            <button
                class="view-toggle active px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 transition-colors font-semibold"
                data-view="month"
            >
                Month
            </button>
            <button
                class="view-toggle px-4 py-2 bg-white border border-gray-300 hover:bg-gray-50 transition-colors font-semibold text-gray-700"
                data-view="week"
            >
                Week
            </button>
            <button
                class="view-toggle px-4 py-2 bg-white border border-gray-300 hover:bg-gray-50 transition-colors font-semibold text-gray-700"
                data-view="day"
            >
                Day
            </button>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div id="calendar-view" class="p-4">
        <!-- Day Names Header -->
        <div class="grid grid-cols-7 gap-px mb-px bg-gray-200">
            <div
                class="bg-gray-50 p-3 text-center font-bold text-gray-700 text-sm"
            >
                SUN
            </div>
            <div
                class="bg-gray-50 p-3 text-center font-bold text-gray-700 text-sm"
            >
                MON
            </div>
            <div
                class="bg-gray-50 p-3 text-center font-bold text-gray-700 text-sm"
            >
                TUE
            </div>
            <div
                class="bg-gray-50 p-3 text-center font-bold text-gray-700 text-sm"
            >
                WED
            </div>
            <div
                class="bg-gray-50 p-3 text-center font-bold text-gray-700 text-sm"
            >
                THU
            </div>
            <div
                class="bg-gray-50 p-3 text-center font-bold text-gray-700 text-sm"
            >
                FRI
            </div>
            <div
                class="bg-gray-50 p-3 text-center font-bold text-gray-700 text-sm"
            >
                SAT
            </div>
        </div>

        <!-- Calendar Days Grid -->
        <div
            id="calendar-days"
            class="grid grid-cols-7 gap-px bg-gray-200 min-h-[600px]"
        >
            <!-- Days will be populated by JavaScript -->
        </div>
    </div>
</div>

<!-- Event Modal -->
<div
    id="event-modal"
    class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm"
>
    <div class="bg-white w-full max-w-2xl shadow-2xl border border-gray-300">
        <div
            class="bg-blue-600 text-white p-6 flex justify-between items-center"
        >
            <h3 class="text-2xl font-black">Event Details</h3>
            <button
                id="close-modal"
                class="text-white hover:text-gray-200 text-3xl font-bold"
                >×</button
            >
        </div>
        <div id="modal-content" class="p-6">
            <!-- Event details will be populated here -->
        </div>
    </div>
</div>

<script>

    let currentDate = new Date();
    let currentView = "month";
    let events: any[] = [];

    window.updateCalendarEvents = (newEvents) => {
        events = newEvents.map(e => {
             let color = 'bg-blue-600';
             if (e.category === 'Technology') color = 'bg-blue-600';
             else if (e.category === 'Cultural') color = 'bg-purple-600';
             else if (e.category === 'Sports') color = 'bg-green-600';
             else if (e.category === 'Academic') color = 'bg-yellow-600';
             else color = 'bg-gray-600';

             const d = new Date(e.date);
             const year = d.getFullYear();
             const month = String(d.getMonth() + 1).padStart(2, '0');
             const day = String(d.getDate()).padStart(2, '0');
             const dateStr = `${year}-${month}-${day}`;

             return {
                id: e.publicId,
                title: e.title,
                date: dateStr,
                time: new Date(e.startTime).toLocaleTimeString('en-IN', {hour: '2-digit', minute:'2-digit'}),
                location: e.venue,
                description: e.description,
                category: e.category,
                color: color
            };
        });
        renderCalendar();
    };

    function renderCalendar() {
        const calendarDays = document.getElementById("calendar-days");
        if (!calendarDays) return;
        calendarDays.innerHTML = "";
        
        updateHeader();
        
        if (currentView === 'month') {
            calendarDays.className = "grid grid-cols-7 gap-px bg-gray-200 min-h-[600px]";
            renderMonthView(calendarDays);
        } else if (currentView === 'week') {
            calendarDays.className = "grid grid-cols-7 gap-px bg-gray-200 min-h-[600px]";
            renderWeekView(calendarDays);
        } else if (currentView === 'day') {
            calendarDays.className = "grid grid-cols-1 gap-px bg-gray-200 min-h-[600px]";
            renderDayView(calendarDays);
        }
    }

    function updateHeader() {
        const monthNames = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];
        
        const monthElement = document.getElementById("current-month");
        const yearElement = document.getElementById("current-year");
        
        if (currentView === 'day') {
             if (monthElement) monthElement.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getDate()},`;
             if (yearElement) yearElement.textContent = currentDate.getFullYear().toString();
        } else if (currentView === 'week') {
            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            if (monthElement) {
                if (startOfWeek.getMonth() === endOfWeek.getMonth()) {
                     monthElement.textContent = `${monthNames[startOfWeek.getMonth()]}`;
                } else {
                     monthElement.textContent = `${monthNames[startOfWeek.getMonth()].slice(0, 3)} - ${monthNames[endOfWeek.getMonth()].slice(0, 3)}`;
                }
            }
            if (yearElement) yearElement.textContent = currentDate.getFullYear().toString();
        } else {
             if (monthElement) monthElement.textContent = monthNames[currentDate.getMonth()];
             if (yearElement) yearElement.textContent = currentDate.getFullYear().toString();
        }
    }

    function renderMonthView(container) {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();

        // Previous month days
        for (let i = firstDay - 1; i >= 0; i--) {
            container.appendChild(createDayCell(daysInPrevMonth - i, true, year, month - 1));
        }

        // Current month days
        for (let day = 1; day <= daysInMonth; day++) {
            container.appendChild(createDayCell(day, false, year, month));
        }

        const totalCells = firstDay + daysInMonth;
        const remainingCells = 42 - totalCells;
        for (let day = 1; day <= remainingCells; day++) {
            container.appendChild(createDayCell(day, true, year, month + 1));
        }
    }

    function renderWeekView(container) {
        const startOfWeek = new Date(currentDate);
        startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
        
        for (let i = 0; i < 7; i++) {
            const date = new Date(startOfWeek);
            date.setDate(startOfWeek.getDate() + i);
            container.appendChild(createDayCell(date.getDate(), false, date.getFullYear(), date.getMonth()));
        }
    }

    function renderDayView(container) {
        container.appendChild(createDayCell(currentDate.getDate(), false, currentDate.getFullYear(), currentDate.getMonth()));
    }

    function createDayCell(day, isOtherMonth, year, month) {
        const dayDiv = document.createElement("div");
        dayDiv.className = `bg-white p-2 min-h-[100px] border-gray-200 hover:bg-gray-50 transition-colors ${isOtherMonth ? "text-gray-400 bg-gray-50" : "text-gray-900"}`;

        const checkDate = new Date(year, month, day);
        
        const y = checkDate.getFullYear();
        const m = String(checkDate.getMonth() + 1).padStart(2, "0");
        const d = String(checkDate.getDate()).padStart(2, "0");
        const dateStr = `${y}-${m}-${d}`;
        
        const today = new Date();
        const isToday = checkDate.toDateString() === today.toDateString();

        const header = document.createElement('div');
        header.className = 'flex justify-between items-start mb-2';
        
        const dayNumber = document.createElement("div");
        dayNumber.className = `text-sm font-bold ${isToday ? "bg-blue-600 text-white w-7 h-7 flex items-center justify-center rounded-full" : ""}`;
        dayNumber.style.fontFamily = "'Poppins', sans-serif";
        dayNumber.textContent = day;
        header.appendChild(dayNumber);
        
        if (currentView === 'day') {
             const dayName = document.createElement("span");
             dayName.className = "text-sm font-bold text-gray-500 uppercase";
             dayName.textContent = checkDate.toLocaleDateString('en-US', { weekday: 'long' });
             header.appendChild(dayName);
        }

        dayDiv.appendChild(header);

        // Add events for this day
        const dayEvents = events.filter((event) => event.date === dateStr);
        dayEvents.forEach((event) => {
            const eventDiv = document.createElement("div");
            eventDiv.className = `${event.color} text-white text-xs p-2 mb-1 cursor-pointer hover:opacity-80 transition-opacity rounded`;
            
            if (currentView === 'day') {
                 eventDiv.innerHTML = `<span class="font-bold">${event.time}</span> - ${event.title} <br><span class="text-[10px] opacity-90">${event.location}</span>`;
            } else {
                 eventDiv.textContent = event.title;
            }
            
            eventDiv.onclick = (e) => {
                e.stopPropagation();
                showEventModal(event);
            };
            dayDiv.appendChild(eventDiv);
        });

        return dayDiv;
    }

   function showEventModal(event) {
        const modal = document.getElementById("event-modal");
        const modalContent = document.getElementById("modal-content");

        if (!modalContent || !modal) return;

        modalContent.innerHTML = `
      <div class="space-y-4">
        <div>
          <h4 class="text-2xl font-black text-gray-900 mb-2">${event.title}</h4>
          <span class="inline-block px-3 py-1 ${event.color} text-white text-sm font-bold">${event.category}</span>
        </div>
        <div class="space-y-2">
          <p class="text-gray-700"><span class="font-bold">Date:</span> ${new Date(event.date).toLocaleDateString("en-IN", { weekday: "long", year: "numeric", month: "long", day: "numeric" })}</p>
          <p class="text-gray-700"><span class="font-bold">Time:</span> ${event.time}</p>
          <p class="text-gray-700"><span class="font-bold">Location:</span> ${event.location}</p>
        </div>
        <div>
          <p class="text-gray-700 font-semibold">Description:</p>
          <p class="text-gray-600">${event.description}</p>
        </div>
        <div class="flex gap-3 mt-6">
          <button class="px-6 py-3 bg-blue-600 text-white font-bold hover:bg-blue-700 transition-colors flex-1" onclick="window.location.href='/events/${event.id}'">View Details</button>
        </div>
      </div>
    `;

        modal.classList.remove("hidden");
        modal.classList.add("flex");
    }

    // Event listeners
    document.getElementById("prev-month")?.addEventListener("click", () => {
        if (currentView === 'month') {
            currentDate.setDate(1);
            currentDate.setMonth(currentDate.getMonth() - 1);
        } else if (currentView === 'week') {
            currentDate.setDate(currentDate.getDate() - 7);
        } else if (currentView === 'day') {
            currentDate.setDate(currentDate.getDate() - 1);
        }
        renderCalendar();
    });

    document.getElementById("next-month")?.addEventListener("click", () => {
        if (currentView === 'month') {
            currentDate.setDate(1);
            currentDate.setMonth(currentDate.getMonth() + 1);
        } else if (currentView === 'week') {
            currentDate.setDate(currentDate.getDate() + 7);
        } else if (currentView === 'day') {
            currentDate.setDate(currentDate.getDate() + 1);
        }
        renderCalendar();
    });

    document.getElementById("today-btn")?.addEventListener("click", () => {
        currentDate = new Date();
        renderCalendar();
    });

    document.getElementById("close-modal")?.addEventListener("click", () => {
        const modal = document.getElementById("event-modal");
        if (!modal) return;
        modal.classList.add("hidden");
        modal.classList.remove("flex");
    });
    
    document.getElementById("event-modal")?.addEventListener("click", (e) => {
         if (e.target === document.getElementById("event-modal")) {
             document.getElementById("event-modal").classList.add("hidden");
             document.getElementById("event-modal").classList.remove("flex");
         }
    });

    // View toggle buttons
    document.querySelectorAll(".view-toggle").forEach((btn) => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".view-toggle").forEach((b) => {
                b.classList.remove("active", "bg-blue-600", "text-white");
                b.classList.add(
                    "bg-white",
                    "border",
                    "border-gray-300",
                    "text-gray-700",
                );
            });
            btn.classList.add("active", "bg-blue-600", "text-white");
            btn.classList.remove(
                "bg-white",
                "border",
                "border-gray-300",
                "text-gray-700",
            );
            currentView = (btn as HTMLElement).dataset.view || "month";
            renderCalendar();
        });
    });

    // Initial render
    renderCalendar();
</script>
