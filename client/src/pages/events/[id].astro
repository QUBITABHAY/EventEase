---
export const prerender = false;
import Layout from "../../layouts/Layout.astro";
import Footer from "../../components/Footer.astro";
import Navbar from "../../components/Navbar.astro";
import { API_BASE_URL } from "../../config.js";

const { id } = Astro.params;
let event: any = null;
let error: string | null = null;

try {
  const response = await fetch(`${API_BASE_URL}/api/event/${id}`);
  if (!response.ok) {
    throw new Error("Failed to fetch event");
  }
  const data = await response.json();
  event = data.event;
} catch (e) {
  console.error("Error fetching event:", e);
  error = "Could not load event details.";
}

if (!event && !error) {
    return Astro.redirect('/404');
}
---

<Layout title={event ? `${event.title} | EventEase` : "Event Not Found"}>
    <Navbar />
    
    {error ? (
        <div class="min-h-screen flex items-center justify-center bg-gray-50">
            <div class="text-center">
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Error Loading Event</h1>
                <p class="text-gray-600 mb-4">{error}</p>
                <a href="/events" class="text-blue-600 hover:underline">Back to Events</a>
            </div>
        </div>
    ) : (
        <div class="min-h-screen bg-gray-50 font-sans bg-gradient-to-b from-cyan-500/5 to-transparent">
            <!-- Hero Section -->
            <div class="relative h-[360px] flex items-center justify-center overflow-hidden border-b border-gray-100">
                <img
                    src={event.posterUrl || "https://images.unsplash.com/photo-1540575467063-178a50c2df87?auto=format&fit=crop&q=80&w=2070"}
                    alt={event.title}
                    class="w-full h-full object-cover brightness-50"
                />
                <div class="absolute inset-0 bg-black/35"></div>
                <div class="absolute text-center text-white z-10 max-w-[90%]">
                    <h1 class="text-4xl md:text-5xl font-extrabold mb-3 font-serif">
                        {event.title}
                    </h1>
                    <p class="bg-blue-600 text-white inline-block px-3.5 py-1.5 rounded-md text-sm font-semibold">
                        {event.category}
                    </p>
                </div>
            </div>

            <!-- Main Content -->
            <div class="grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-10 max-w-6xl mx-auto my-12 px-5 md:px-10">
                <div class="bg-white border border-gray-200 rounded-xl p-8 shadow-sm">
                    <h2 class="text-3xl font-bold mb-4 text-gray-800 font-serif">
                        {event.title}
                    </h2>
                    <p class="text-lg text-gray-600 mb-6 leading-relaxed">
                        {event.description}
                    </p>

                    <div class="bg-slate-50 border border-gray-200 rounded-lg p-5 mt-4 space-y-3">
                        <p class="text-base text-gray-800 mb-3">
                            <strong>Organized by:</strong>
                            {event.organizer?.name || "Event Organizer"}
                        </p>
                        <p class="text-base text-gray-800 mb-3">
                            <strong>Venue:</strong>
                            {event.venue}
                        </p>
                        <p class="text-base text-gray-800 mb-3">
                            <strong>Dates:</strong>
                            {new Date(event.startTime).toLocaleDateString()} - {new Date(event.endTime).toLocaleDateString()}
                        </p>
                        <p class="text-base text-gray-800 mb-3">
                            <strong>Capacity:</strong>
                            {event.capacity?.toLocaleString() || "Unlimited"} participants
                        </p>
                        <p class="text-base text-gray-800 mb-3">
                            <strong>Price:</strong>
                            {event.price === 0 ? "Free" : `$${event.price}`}
                        </p>
                    </div>


                    <button
                        class="inline-block bg-blue-600 text-white font-semibold rounded-lg px-6 py-3 mt-6 hover:bg-blue-700 transition-colors cursor-pointer border-0 disabled:opacity-50 disabled:cursor-not-allowed"
                        id="joinEventBtn"
                        data-event-id={event.id}>Join Event</button>
                    
                </div>

                <!-- Sidebar -->
                <aside class="flex flex-col gap-6">
                    <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                        <h3 class="text-lg font-bold mb-3 text-blue-600 border-b border-gray-200 pb-2 font-serif">
                            Quick Info
                        </h3>
                        <p class="mb-2.5 text-sm text-gray-600 flex items-center gap-2">
                            <span>üíª</span>
                            <b>Online / In-person:</b>
                            {event.venue?.toLowerCase().includes("online") ? "Online" : "In-person"}
                        </p>
                        <p class="mb-2.5 text-sm text-gray-600 flex items-center gap-2">
                            <span>üìÖ</span>
                            <b>Start:</b>
                            {new Date(event.startTime).toLocaleString()}
                        </p>
                        <p class="mb-2.5 text-sm text-gray-600 flex items-center gap-2">
                            <span>üèÅ</span>
                            <b>End:</b>
                            {new Date(event.endTime).toLocaleString()}
                        </p>
                        <p class="mb-2.5 text-sm text-gray-600 flex items-center gap-2">
                            <span>üß†</span>
                            <b>Category:</b>
                            {event.category}
                        </p>
                        <p class="mb-2.5 text-sm text-gray-600 flex items-center gap-2">
                            <span>üí∞</span>
                            <b>Prize Pool:</b> ‚Çπ{event.prizePool || 0}
                        </p>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                        <h3 class="text-lg font-bold mb-3 text-blue-600 border-b border-gray-200 pb-2 font-serif">
                            Tags
                        </h3>
                        <div class="flex flex-wrap gap-2 mt-2">
                            <span class="bg-indigo-50 text-indigo-600 font-medium px-3 py-1 rounded-md text-sm">
                                {event.category}
                            </span>
                            <span class="bg-indigo-50 text-indigo-600 font-medium px-3 py-1 rounded-md text-sm">
                                Tech
                            </span>
                        </div>
                    </div>
                </aside>
            </div>

            <!-- Additional Info Section -->
            <section class="bg-gray-50 py-16 mt-12 border-t border-gray-200">
                <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8 px-8">
                    <div class="bg-white border border-gray-200 rounded-xl p-8 shadow-sm hover:shadow-lg hover:-translate-y-0.5 transition-all">
                        <h2 class="text-blue-500 text-2xl mb-4 flex items-center gap-2 font-bold font-serif">
                            üèÜ Prize Pool Details
                        </h2>
                        <p class="text-slate-700 text-base leading-relaxed">
                            {event.prizePool ? event.prizeDescription || `Total prize pool of ‚Çπ${event.prizePool}` : "No monetary prizes for this event, but participants gain valuable networking opportunities and exposure."}
                        </p>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl p-8 shadow-sm hover:shadow-lg hover:-translate-y-0.5 transition-all">
                        <h2 class="text-blue-500 text-2xl mb-4 flex items-center gap-2 font-bold font-serif">
                            üß† About the Event
                        </h2>
                        <p class="text-slate-700 text-base leading-relaxed">
                            {event.longDescription || event.description || "Join us for this exciting event!"}
                        </p>
                    </div>
                </div>
            </section>
        </div>
    )}
    <Footer />

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const joinBtn = document.getElementById('joinEventBtn') as HTMLButtonElement;
            
            if (joinBtn) {
                const eventId = parseInt(joinBtn.dataset.eventId || '0');
                
                // Check registration status on page load
                async function checkRegistrationStatus() {
                    try {
                        const response = await fetch(`http://localhost:3000/api/registration/check/${eventId}`, {
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            if (result.isRegistered) {
                                // User is already registered
                                joinBtn.textContent = '‚úì Registration Successful!';
                                joinBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                                joinBtn.classList.add('bg-green-600');
                                joinBtn.disabled = true;
                            }
                        }
                    } catch (error) {
                        console.error('Error checking registration:', error);
                    }
                }
                
                // Check on load (only if user is logged in)
                checkRegistrationStatus();
                
                joinBtn.addEventListener('click', async function() {
                    const eventId = parseInt(this.dataset.eventId || '0');
                    
                    if (!eventId) {
                        alert('Invalid event');
                        return;
                    }

                    // Disable button during request
                    joinBtn.disabled = true;
                    const originalText = joinBtn.textContent;
                    joinBtn.textContent = 'Registering...';

                    try {
                        const response = await fetch('http://localhost:3000/api/registration/register', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'include', // Important: sends cookies
                            body: JSON.stringify({ eventId })
                        });

                        const result = await response.json();

                        if (response.ok) {
                            joinBtn.textContent = '‚úì Registration Successful!';
                            joinBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                            joinBtn.classList.add('bg-green-600');
                            // Keep disabled
                        } else {
                            // Handle errors
                            if (response.status === 401) {
                                alert('Please login to register for this event');
                                window.location.href = '/login';
                            } else {
                                alert(result.message || 'Registration failed');
                                joinBtn.disabled = false;
                                joinBtn.textContent = originalText;
                            }
                        }
                    } catch (error) {
                        console.error('Registration error:', error);
                        alert('An error occurred. Please try again.');
                        joinBtn.disabled = false;
                        joinBtn.textContent = originalText;
                    }
                });
            }
        });
    </script>
</Layout>
