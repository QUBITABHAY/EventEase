---
export const prerender = false;
import Layout from "../../layouts/Layout.astro";
import Footer from "../../components/Footer.astro";
import Navbar from "../../components/Navbar.astro";
import { API_BASE_URL } from "../../config.js";

const { id } = Astro.params;

let event: any = null;
let error: string | null = null;

try {
  const response = await fetch(`${API_BASE_URL}/api/event/${id}`);
  if (!response.ok) {
    throw new Error("Failed to fetch event");
  }
  const data = await response.json();
  event = data.event;
} catch (e) {
  console.error("Error fetching event:", e);
  error = "Could not load event details.";
}

if (!event && !error) {
    return Astro.redirect('/404');
}


let userReview = null;
try {
  const reviewResponse = await fetch(`${API_BASE_URL}/api/reviews/${id}`, {
    credentials: "include",
  });
  if (reviewResponse.ok) {
    userReview = await reviewResponse.json();
  }
} catch (error) {
  console.error("Error fetching user review:", error);
}
---

<Layout title={event ? `${event.title} | EventEase` : "Event Not Found"}>
    <Navbar />
    
    {error ? (
        <div class="min-h-screen flex items-center justify-center bg-gray-50">
            <div class="text-center">
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Error Loading Event</h1>
                <p class="text-gray-600 mb-4">{error}</p>
                <a href="/events" class="text-blue-600 hover:underline">Back to Events</a>
            </div>
        </div>
    ) : (
        <div class="min-h-screen bg-gray-50 font-sans bg-gradient-to-b from-cyan-500/5 to-transparent">
            <!-- Hero Section -->
            <div class="relative h-[360px] flex items-center justify-center overflow-hidden border-b border-gray-100">
                <img
                    src={event.posterUrl || "https://images.unsplash.com/photo-1540575467063-178a50c2df87?auto=format&fit=crop&q=80&w=2070"}
                    alt={event.title}
                    class="w-full h-full object-cover brightness-50"
                />
                <div class="absolute inset-0 bg-black/35"></div>
                <div class="absolute text-center text-white z-10 max-w-[90%]">
                    <h1 class="text-4xl md:text-5xl font-extrabold mb-3 font-serif">
                        {event.title}
                    </h1>
                    <p class="bg-blue-600 text-white inline-block px-3.5 py-1.5 rounded-md text-sm font-semibold">
                        {event.category}
                    </p>
                </div>
            </div>

            <!-- Main Content -->
            <div class="grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-10 max-w-6xl mx-auto my-12 px-5 md:px-10">
                <div class="bg-white border border-gray-200 rounded-xl p-8 shadow-sm">
                    <h2 class="text-3xl font-bold mb-4 text-gray-800 font-serif">
                        {event.title}
                    </h2>
                    <p class="text-lg text-gray-600 mb-6 leading-relaxed">
                        {event.description}
                    </p>

                    <div class="bg-slate-50 border border-gray-200 rounded-lg p-5 mt-4 space-y-3">
                        <p class="text-base text-gray-800 mb-3">
                            <strong>Organized by:</strong>
                            {event.organizer?.name || "Event Organizer"}
                        </p>
                        <p class="text-base text-gray-800 mb-3">
                            <strong>Venue:</strong>
                            {event.venue}
                        </p>
                        <p class="text-base text-gray-800 mb-3">
                            <strong>Dates:</strong>
                            {new Date(event.startTime).toLocaleDateString()} - {new Date(event.endTime).toLocaleDateString()}
                        </p>
                        <p class="text-base text-gray-800 mb-3">
                            <strong>Capacity:</strong>
                            {event.capacity?.toLocaleString() || "Unlimited"} participants
                        </p>
                        <p class="text-base text-gray-800 mb-3">
                            <strong>Price:</strong>
                            {event.price === 0 ? "Free" : `$${event.price}`}
                        </p>
                    </div>


                    <button
                        class="inline-block bg-blue-600 text-white font-semibold rounded-lg px-6 py-3 mt-6 hover:bg-blue-700 transition-colors cursor-pointer border-0 disabled:opacity-50 disabled:cursor-not-allowed"
                        id="joinEventBtn"
                        data-event-id={event.id}>Join Event</button>
                    
                </div>

                <!-- Sidebar -->
                <aside class="flex flex-col gap-6">
                    <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                        <h3 class="text-lg font-bold mb-3 text-blue-600 border-b border-gray-200 pb-2 font-serif">
                            Quick Info
                        </h3>
                        <p class="mb-2.5 text-sm text-gray-600 flex items-center gap-2">
                            <span>üíª</span>
                            <b>Online / In-person:</b>
                            {event.venue?.toLowerCase().includes("online") ? "Online" : "In-person"}
                        </p>
                        <p class="mb-2.5 text-sm text-gray-600 flex items-center gap-2">
                            <span>üìÖ</span>
                            <b>Start:</b>
                            {new Date(event.startTime).toLocaleString()}
                        </p>
                        <p class="mb-2.5 text-sm text-gray-600 flex items-center gap-2">
                            <span>üèÅ</span>
                            <b>End:</b>
                            {new Date(event.endTime).toLocaleString()}
                        </p>
                        <p class="mb-2.5 text-sm text-gray-600 flex items-center gap-2">
                            <span>üß†</span>
                            <b>Category:</b>
                            {event.category}
                        </p>
                        <p class="mb-2.5 text-sm text-gray-600 flex items-center gap-2">
                            <span>üí∞</span>
                            <b>Prize Pool:</b> ‚Çπ{event.prizePool || 0}
                        </p>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                        <h3 class="text-lg font-bold mb-3 text-blue-600 border-b border-gray-200 pb-2 font-serif">
                            Tags
                        </h3>
                        <div class="flex flex-wrap gap-2 mt-2">
                            <span class="bg-indigo-50 text-indigo-600 font-medium px-3 py-1 rounded-md text-sm">
                                {event.category}
                            </span>
                            <span class="bg-indigo-50 text-indigo-600 font-medium px-3 py-1 rounded-md text-sm">
                                Tech
                            </span>
                        </div>
                    </div>
                </aside>
            </div>

            <!-- Additional Info Section -->
            <section class="bg-gray-50 py-16 mt-12 border-t border-gray-200">
                <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8 px-8">
                    <div class="bg-white border border-gray-200 rounded-xl p-8 shadow-sm hover:shadow-lg hover:-translate-y-0.5 transition-all">
                        <h2 class="text-blue-500 text-2xl mb-4 flex items-center gap-2 font-bold font-serif">
                            üèÜ Prize Pool Details
                        </h2>
                        <p class="text-slate-700 text-base leading-relaxed">
                            {event.prizePool ? event.prizeDescription || `Total prize pool of ‚Çπ${event.prizePool}` : "No monetary prizes for this event, but participants gain valuable networking opportunities and exposure."}
                        </p>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl p-8 shadow-sm hover:shadow-lg hover:-translate-y-0.5 transition-all">
                        <h2 class="text-blue-500 text-2xl mb-4 flex items-center gap-2 font-bold font-serif">
                            üß† About the Event
                        </h2>
                        <p class="text-slate-700 text-base leading-relaxed">
                            {event.longDescription || event.description || "Join us for this exciting event!"}
                        </p>
                    </div>
                </div>
                
            </section>
            <section class="mt-12 max-w-3xl mx-auto px-4">
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="p-6 md:p-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-amber-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
        </svg>
        Leave a Review
      </h2>

      {userReview ? (
        <div class="bg-amber-50 border-l-4 border-amber-400 p-4 rounded">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-amber-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-amber-800">Your Review</h3>
              <div class="mt-2 text-sm text-amber-700">
                <p class="flex items-center">
                  <span class="font-medium">Rating:</span>
                  <span class="flex ml-2">
                    {Array.from({ length: 5 }).map((_, i) => (
                      <svg 
                        key={i} 
                        class={`h-5 w-5 ${i < userReview.rating ? 'text-amber-400' : 'text-gray-300'}`} 
                        fill="currentColor" 
                        viewBox="0 0 20 20"
                      >
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                      </svg>
                    ))}
                    <span class="ml-2 text-amber-900">({userReview.rating}.0/5.0)</span>
                  </span>
                </p>
                {userReview.feedback && (
                  <p class="mt-2">
                    <span class="font-medium">Feedback:</span>
                    <span class="ml-2">{userReview.feedback}</span>
                  </p>
                )}
              </div>
            </div>
          </div>
        </div>
      ) : (
        <form id="reviewForm" class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              How would you rate this event?
              <span class="text-red-500">*</span>
            </label>
            <div class="flex items-center space-x-1">
              {[1, 2, 3, 4, 5].map((rating) => (
                <div key={rating} class="relative">
                  <input
                    type="radio"
                    id={`rating-${rating}`}
                    name="rating"
                    value={rating}
                    class="sr-only"
                    required
                    {rating === 5 ? 'checked' : ''}
                  />
                  <label
                    for={`rating-${rating}`}
                    class="star-rating block w-10 h-10 cursor-pointer text-gray-300 peer-hover:text-amber-400 transition-colors duration-200"
                    data-rating={rating}
                  >
                    <svg
                      class="w-full h-full"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                    </svg>
                  </label>
                </div>
              ))}
              <span id="rating-text" class="ml-3 text-sm font-medium text-gray-500">
                Select a rating
              </span>
            </div>
            <p class="mt-1 text-xs text-gray-500">Click on a star to rate</p>
          </div>

          <div>
            <label for="feedback" class="block text-sm font-medium text-gray-700 mb-2">
              Share your experience
              <span class="text-red-500">*</span>
            </label>
            <textarea
              id="feedback"
              name="feedback"
              rows="4"
              class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150"
              placeholder="What did you like or dislike about this event?"
              required
            ></textarea>
            <p class="mt-1 text-xs text-gray-500">Your feedback helps us improve future events</p>
          </div>

          <div class="pt-2">
            <button
              type="submit"
              class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200"
            >
              Submit Review
            </button>
          </div>
        </form>
      )}
    </div>
  </div>
</section>
        </div>

    )}
    <Footer />


    
<script define:vars={{ API_BASE_URL, id }}>
  document.addEventListener('DOMContentLoaded', () => {
    // Review form elements
    const reviewForm = document.getElementById("reviewForm");
    const ratingInputs = document.querySelectorAll('input[name="rating"]');
    const ratingText = document.getElementById('rating-text');
    const ratingTexts = ['Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
    const starLabels = document.querySelectorAll('label[for^="rating-"]');

    // Function to update star display
    function updateStarDisplay(selectedRating) {
      starLabels.forEach((label, index) => {
        const starIcon = label.querySelector('svg');
        if (starIcon) {
          if (index < selectedRating) {
            starIcon.classList.remove('text-gray-300');
            starIcon.classList.add('text-amber-400');
          } else {
            starIcon.classList.remove('text-amber-400');
            starIcon.classList.add('text-gray-300');
          }
        }
      });
    }

    // Initialize stars
    updateStarDisplay(0);

    // Handle star clicks and hovers
    starLabels.forEach((label, index) => {
      const input = document.getElementById(`rating-${index + 1}`);
      
      // Click handler
      label.addEventListener('click', (e) => {
        e.preventDefault();
        const rating = index + 1;
        input.checked = true;
        updateStarDisplay(rating);
        ratingText.textContent = `${rating}.0 - ${ratingTexts[rating - 1]}`;
        ratingText.classList.remove('text-gray-500');
        ratingText.classList.add('text-amber-600');
      });

      // Hover effects
      label.addEventListener('mouseenter', () => {
        updateStarDisplay(index + 1);
      });

      label.addEventListener('mouseleave', () => {
        const selectedInput = document.querySelector('input[name="rating"]:checked');
        updateStarDisplay(selectedInput ? parseInt(selectedInput.value) : 0);
      });
    });


     async function checkAuth() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/auth/check`, {
          credentials: 'include'
        });
        return response.ok;
      } catch (error) {
        console.error('Auth check failed:', error);
        return false;
      }
    }

    // Function to show error message
    function showError(message) {
      const errorMessage = document.createElement('div');
      errorMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center';
      errorMessage.innerHTML = `
        <svg class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        ${message}
      `;
      document.body.appendChild(errorMessage);
      setTimeout(() => errorMessage.remove(), 5000);
    }



    // Form submission
// Form submission
// In your form submission handler
reviewForm?.addEventListener("submit", async (e) => {
  e.preventDefault();
  
  const submitButton = reviewForm.querySelector('button[type="submit"]');
  if (!submitButton) return;
  
  const originalButtonText = submitButton.innerHTML;
  
  try {
    // Show loading state
    submitButton.disabled = true;
    submitButton.innerHTML = `Submitting...`;

    const formData = new FormData(reviewForm);
    const rating = formData.get('rating');
    const feedback = formData.get('feedback');


  // Get the event's primary ID from the hidden input or data attribute
    const eventId = document.querySelector('[data-event-id]')?.dataset.eventId;
    console.log(eventId);
    if (!rating) {
      throw new Error('Please select a rating');
    }

    // Get or generate a user ID
    let userId = localStorage.getItem('userId');
    if (!userId) {
      // Generate a simple unique ID if one doesn't exist
      userId = Math.floor(1000 + Math.random() * 9000);
      localStorage.setItem('userId', userId);
    }

    const response = await fetch(`${API_BASE_URL}/api/reviews`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  credentials: 'include', // Important for sending cookies
  body: JSON.stringify({
    eventId: eventId,
    rating: parseInt(rating),
    feedback: feedback?.toString().trim() || ''
  }),
});
    
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error.message || 'Failed to submit review');
    }
    
    // Show success message
    const successMessage = document.createElement('div');
    successMessage.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center';
    successMessage.innerHTML = 'Thank you for your review!';
    document.body.appendChild(successMessage);
    
    // Remove message and reload after delay
    setTimeout(() => {
      successMessage.remove();
      window.location.reload();
    }, 2000);
    
  } catch (error) {
    console.error("Error submitting review:", error);
    
    // Show error message
    const errorMessage = document.createElement('div');
    errorMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    errorMessage.textContent = error.message || 'An error occurred. Please try again.';
    document.body.appendChild(errorMessage);
    
    // Auto-remove error message after 5 seconds
    setTimeout(() => {
      errorMessage.remove();
    }, 5000);
    
    // Reset button state
    submitButton.disabled = false;
    submitButton.innerHTML = originalButtonText;
  }
});


   async function loadUserReview() {
  try {
    const userId = localStorage.getItem('userId');
    if (!userId) return;

    const response = await fetch(`${API_BASE_URL}/api/reviews/event/${id}/user-review?userId=${userId}`, {
      credentials: 'include'
    });
    
    if (response.status === 404) return;
    if (!response.ok) throw new Error('Failed to load review');

    const data = await response.json();
    if (data.review) {
      const { rating, feedback } = data.review;
      const ratingInput = document.querySelector(`input[name="rating"][value="${rating}"]`);
      if (ratingInput) {
        ratingInput.checked = true;
        updateStarDisplay(rating);
        const feedbackTextarea = document.querySelector('textarea[name="feedback"]');
        if (feedbackTextarea) {
          feedbackTextarea.value = feedback || '';
        }
        if (ratingText) {
          ratingText.textContent = `${rating}.0 - ${ratingTexts[rating - 1]}`;
          ratingText.classList.remove('text-gray-500');
          ratingText.classList.add('text-amber-600');
        }
      }
    }
  } catch (error) {
    console.error('Error loading user review:', error);
  }
}


    // Check for existing review
    loadUserReview();

    // Join event button functionality
    const joinBtn = document.getElementById('joinEventBtn');
    
    if (joinBtn) {
      const eventId = parseInt(joinBtn.dataset.eventId || '0');
      
      // Check registration status on page load
      async function checkRegistrationStatus() {
        try {
          const response = await fetch(`${API_BASE_URL}//api/registration/check/${eventId}`, {
            credentials: 'include'
          });
          
          if (response.ok) {
            const result = await response.json();
            if (result.isRegistered) {
              // User is already registered
              joinBtn.textContent = '‚úì Registration Successful!';
              joinBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
              joinBtn.classList.add('bg-green-600');
              joinBtn.disabled = true;
            }
          }
        } catch (error) {
          console.error('Error checking registration:', error);
        }
      }
      
      // Check registration status on load
      checkRegistrationStatus();
      const pendingReview = sessionStorage.getItem('pendingReview');
if (pendingReview) {
  try {
    const reviewData = JSON.parse(pendingReview);
    // Clear the pending review
    sessionStorage.removeItem('pendingReview');
    
    // Check if this is the same event
    if (reviewData.eventId === id) {
      // Small delay to ensure the DOM is fully loaded
      setTimeout(async () => {
        // Check if user is authenticated
        const isAuthenticated = await checkAuth();
        if (isAuthenticated) {
          // Submit the review
          await submitReview(reviewData);
        }
      }, 500);
    }
  } catch (error) {
    console.error('Error processing pending review:', error);
  }
}

// Restore scroll position if it was saved
const savedPosition = sessionStorage.getItem('scrollPosition');
if (savedPosition !== null) {
  const scrollPosition = parseInt(savedPosition, 10);
  window.scrollTo(0, scrollPosition);
  sessionStorage.removeItem('scrollPosition');
}
      
    }
  });

  
            const joinBtn = document.getElementById('joinEventBtn');
            
            if (joinBtn) {
                const eventId = parseInt(joinBtn.dataset.eventId || '0');
                
                // Check registration status on page load
                async function checkRegistrationStatus() {
                    try {
                        const response = await fetch(`http://localhost:3000/api/registration/check/${eventId}`, {
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            if (result.isRegistered) {
                                // User is already registered
                                joinBtn.textContent = '‚úì Registration Successful!';
                                joinBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                                joinBtn.classList.add('bg-green-600');
                                joinBtn.disabled = true;
                            }
                        }
                    } catch (error) {
                        console.error('Error checking registration:', error);
                    }
                }
                
                // Check on load (only if user is logged in)
                checkRegistrationStatus();
                
                joinBtn.addEventListener('click', async function() {
                    const eventId = parseInt(this.dataset.eventId || '0');
                    
                    if (!eventId) {
                        alert('Invalid event');
                        return;
                    }

                    // Disable button during request
                    joinBtn.disabled = true;
                    const originalText = joinBtn.textContent;
                    joinBtn.textContent = 'Registering...';

                    try {
                        const response = await fetch('http://localhost:3000/api/registration/register', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'include', // Important: sends cookies
                            body: JSON.stringify({ eventId })
                        });

                        const result = await response.json();

                        if (response.ok) {
                            joinBtn.textContent = '‚úì Registration Successful!';
                            joinBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                            joinBtn.classList.add('bg-green-600');
                            // Keep disabled
                        } else {
                            // Handle errors
                            if (response.status === 401) {
                                alert('Please login to register for this event');
                                window.location.href = '/login';
                            } else {
                                alert(result.message || 'Registration failed');
                                joinBtn.disabled = false;
                                joinBtn.textContent = originalText;
                            }
                        }
                    } catch (error) {
                        console.error('Registration error:', error);
                        alert('An error occurred. Please try again.');
                        joinBtn.disabled = false;
                        joinBtn.textContent = originalText;
                    }
                });
            }
        
    </script>
</Layout>
