---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
---

<Layout title="CompleteProfile - EventEase">
  <Navbar />

  <main
    class="relative min-h-screen flex items-center justify-center p-8 bg-gradient-to-br from-[#e8f4ff] to-[#f0f9ff] overflow-hidden"
  >
    <div class="absolute top-0 left-0 right-0 bottom-0 overflow-hidden z-0">
      <div
        class="absolute rounded-full filter blur-[100px] opacity-30 animate-float w-[500px] h-[500px] bg-gradient-to-br from-[#002ffe] to-[#000000] top-[-200px] right-[-200px]"
      >
      </div>
      <div
        class="absolute rounded-full filter blur-[100px] opacity-30 animate-float w-[400px] h-[400px] bg-gradient-to-br from-[#0066ff] to-[#00ccff] bottom-[-150px] left-[-150px] delay-[5s]"
      >
      </div>
    </div>

    <div class="relative z-10 max-w-[1100px]">
      <div class="w-full max-w-2xl">
        <div class="flex items-center justify-center gap-8 mb-10">
          <div class="flex flex-col items-center">
            <div
              class="w-10 h-10 flex items-center justify-center rounded-full border-2 border-blue-600 bg-blue-600 text-white font-medium transition-all duration-300"
              data-progress="1"
            >
              1
            </div>
            <span class="text-sm mt-2 text-gray-700 font-medium">Personal</span>
          </div>

          <div
            class="w-16 h-1 bg-gray-300 rounded-full transition-all duration-300"
            data-line="1"
          >
          </div>

          <div class="flex flex-col items-center">
            <div
              class="w-10 h-10 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-500 font-medium transition-all duration-300"
              data-progress="2"
            >
              2
            </div>
            <span class="text-sm mt-2 text-gray-700 font-medium">Contact</span>
          </div>

          <div
            class="w-16 h-1 bg-gray-300 rounded-full transition-all duration-300"
            data-line="2"
          >
          </div>

          <div class="flex flex-col items-center">
            <div
              class="w-10 h-10 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-500 font-medium transition-all duration-300"
              data-progress="3"
            >
              3
            </div>
            <span class="text-sm mt-2 text-gray-700 font-medium">Address</span>
          </div>
        </div>

        <div
          class="bg-white shadow-2xl rounded-3xl p-10 w-full transition-all duration-300 border-t-8 border-blue-600/80 transform hover:scale-[1.01]"
        >
          <form id="multiStepForm" class="space-y-8">
            <div class="form-step space-y-10" data-step="1">
              <h2
                class="text-3xl font-extrabold text-gray-900 mb-8 text-center border-b pb-3"
              >
                <span class="text-blue-600">Personal</span> Information
              </h2>

              <div class="space-y-6">
                <div>
                  <label
                    for="firstName"
                    class="text-sm font-semibold text-gray-700"
                    >First Name</label
                  >
                  <div class="relative">
                    <svg
                      class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"
                      ></path>
                      <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <input
                      type="text"
                      id="firstName"
                      name="firstName"
                      placeholder="John"
                      required
                      class="w-full py-3 px-4 pl-12 rounded-none text-base bg-gray-50
                      transition-all duration-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-300/20
                      hover:border-gray-400 my-3"
                    />
                  </div>
                </div>

                <div>
                  <label
                    for="lastName"
                    class="text-sm font-semibold text-gray-700">Last Name</label
                  >

                  <div class="relative">
                    <svg
                      class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"
                      ></path>
                      <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <input
                      type="text"
                      id="lastName"
                      name="lastName"
                      placeholder="Doe"
                      required
                      class="w-full py-3 px-4 pl-12 rounded-none text-base bg-gray-50
                      transition-all duration-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-300/20
                      hover:border-gray-400 my-3"
                    />
                  </div>
                </div>
              </div>

              <button
                type="button"
                class="w-full h-10 py-4 text-white font-semibold text-md flex items-center justify-center gap-2
                    bg-blue-700 hover:bg-blue-900 transition-all duration-300 rounded-sm cursor-pointer"
                id="nextStep1"
              >
                <span>Continue</span>
                <svg
                  class="w-5 h-5"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                  <polyline points="12 5 19 12 12 19"></polyline>
                </svg>
              </button>
            </div>

            <div class="form-step hidden space-y-10" data-step="2">
              <h2
                class="text-3xl font-extrabold text-gray-900 mb-8 text-center border-b pb-3"
              >
                <span class="text-blue-600">Contact</span> Information
              </h2>

              <div class="space-y-6">
                <div>
                  <label
                    for="phone"
                    class="block text-sm font-semibold text-gray-700 mb-1"
                    >Phone Number</label
                  >
                  <div class="relative mt-3">
                    <svg
                      class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        d="M22 16.92v3a2 2 0 0 1-2.18 2 19.86 19.86 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.86 19.86 0 0 1 2 4.18 2 2 0 0 1 4 2h3a2 2 0 0 1 2 1.72c.13.94.38 1.85.73 2.71a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.37-1.37a2 2 0 0 1 2.11-.45c.86.35 1.77.6 2.71.73a2 2 0 0 1 1.72 2z"
                      ></path>
                    </svg>
                    <input
                      type="tel"
                      id="phone"
                      name="phone"
                      class="w-full py-3 px-4 pl-12 rounded-none text-base bg-gray-50
                     transition-all duration-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-300/20
                     hover:border-gray-400"
                      placeholder="+1 234 567 890"
                      required
                      autocomplete="tel"
                    />
                  </div>
                </div>
              </div>

              <div class="flex justify-end mt-10 gap-2">
                <button
                  type="button"
                  class="w-full h-10 py-4 text-black font-semibold text-md flex items-center justify-center gap-2
                    bg-grey-700 hover:bg-grey-900 transition-all duration-300 rounded-sm cursor-pointer"
                  id="prevStep2"
                >
                  <span class="mr-2">←</span> Back
                </button>

                <button
                  type="button"
                  class="w-full h-10 py-4 text-white font-semibold text-md flex items-center justify-center gap-2
                    bg-blue-700 hover:bg-blue-900 transition-all duration-300 rounded-sm cursor-pointer"
                  id="nextStep2"
                >
                  Continue <span class="ml-2">→</span>
                </button>
              </div>
            </div>

            <div class="form-step hidden space-y-10" data-step="3">
              <h2
                class="text-3xl font-extrabold text-gray-900 mb-8 text-center border-b pb-3"
              >
                <span class="text-blue-600">Account </span> Type
              </h2>
              <div class="gap-10">
                <label for="role" class="font-semibold text-sm text-gray-800"
                  >Account Type</label
                >
                <div class="space-y-6">
                  <div class="relative mt-3">
                    <svg
                      class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
                      ></path>
                      <circle cx="9" cy="7" r="4"></circle>
                      <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                      <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <select
                      id="role"
                      name="role"
                      class="w-full py-3 px-4 pl-12 rounded-none text-base bg-gray-50
                     transition-all duration-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-300/20
                     hover:border-gray-400 cursor-pointer"
                      required
                    >
                      <option value="">Choose account type</option>
                      <option value="organizer">Event Organizer</option>
                      <option value="user">Event Attendee</option>
                      <option value="both">Both Organizer & Attendee</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="flex justify-end mt-10">
                <button
                  type="button"
                  class="w-full h-10 py-4 text-black font-semibold text-md flex items-center justify-center gap-2
                    bg-grey-700 hover:bg-grey-900 transition-all duration-300 rounded-sm cursor-pointer"
                  id="prevStep3"
                >
                  <span class="mr-2">←</span> Back
                </button>

                <button
                  type="submit"
                  class="bg-green-600 text-white w-full h-10 py-4 text-black font-semibold text-md flex items-center justify-center gap-2
                    bg-grey-700 hover:bg-grey-900 transition-all duration-300 rounded-sm cursor-pointer"
                >
                  <span class="mr-2">✓</span> Submit
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</Layout>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("multiStepForm");
    const steps = document.querySelectorAll(".form-step");
    const progressCircles = document.querySelectorAll("[data-progress]");
    const progressLines = document.querySelectorAll("[data-line]");

    const COMPLETE_PROFILE_URL =
      "http://localhost:3000/api/auth/local/complete-profile";
    let currentStep = 0;

    const updateProgressLine = (stepIndex) => {
      progressLines.forEach((line, index) => {
        if (index < stepIndex) {
          line.classList.add("bg-blue-600");
          line.classList.remove("bg-gray-300");
        } else {
          line.classList.remove("bg-blue-600");
          line.classList.add("bg-gray-300");
        }
      });
    };

    const showStep = (i) => {
      currentStep = i;

      steps.forEach((step, index) => {
        step.classList.toggle("hidden", index !== i);
      });

      progressCircles.forEach((circle, index) => {
        if (index <= i) {
          // Completed or Current Step
          circle.classList.add("bg-blue-600", "text-white", "border-blue-600");
          circle.classList.remove("text-gray-500", "border-gray-300");
        } else {
          // Future Step
          circle.classList.remove(
            "bg-blue-600",
            "text-white",
            "border-blue-600"
          );
          circle.classList.add("text-gray-500", "border-gray-300");
        }
      });
      // 3. Update Progress Lines (between circles)
      updateProgressLine(i);
    };

    const validateStep = (stepIndex) => {
      const currentFields = steps[stepIndex].querySelectorAll("[required]");
      let isValid = true;
      currentFields.forEach((field) => {
        if (
          !field.value.trim() ||
          (field.tagName === "SELECT" && field.value === "")
        ) {
          isValid = false;
          field.style.border = "1px solid red";
        } else {
          field.style.border = "none";
        }
      });
      return isValid;
    };

    document.getElementById("nextStep1").onclick = () => {
      // Validate step 0 (Personal Info) and move to step 1 (Contact)
      if (validateStep(0)) showStep(1);
    };
    document.getElementById("nextStep2").onclick = () => {
      // Validate step 1 (Contact) and move to step 2 (Account Type)
      if (validateStep(1)) showStep(2);
    };
    document.getElementById("prevStep2").onclick = () => showStep(0);
    document.getElementById("prevStep3").onclick = () => showStep(1);

    // --- FINAL FORM SUBMISSION HANDLER (UNCHANGED) ---

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!validateStep(2)) {
        alert("Please complete the final step.");
        return;
      }

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      const submissionData = {
        firstName: data.firstName,
        lastName: data.lastName,
        phone: data.phone,
        role: data.role.toUpperCase(),
      };

      try {
        const response = await fetch(COMPLETE_PROFILE_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(submissionData),
          credentials: "include",
        });

        const result = await response.json();

        if (response.ok && response.status === 200) {
          alert(result.message || "Profile setup complete. Welcome!");

          const userRole = result.user.role;
          if (userRole === "ORGANIZER" || userRole === "BOTH") {
            window.location.href = "/organiser";
          } else {
            window.location.href = "/userdashboard";
          }
        } else {
          alert(result.message || "Profile completion failed.");
        }
      } catch (error) {
        console.error("Profile submission error:", error);
        alert("A network error occurred. Please try again.");
      }
    });

    // Initialize state (must be called after functions are defined)
    showStep(currentStep);
  });
</script>
