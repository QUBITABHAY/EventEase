---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
---

<Layout title="Forgot Password - EventEase">
  <Navbar />
  <main
    class="relative min-h-screen flex items-center justify-center p-8 bg-gradient-to-br from-[#e8f4ff] to-[#f0f9ff] overflow-hidden"
  >
    <div class="absolute top-0 left-0 right-0 bottom-0 overflow-hidden z-0">
      <div
        class="absolute rounded-full filter blur-[100px] opacity-30 animate-float w-[500px] h-[500px] bg-gradient-to-br from-[#002ffe] to-[#000000] top-[-200px] right-[-200px]"
      >
      </div>
      <div
        class="absolute rounded-full filter blur-[100px] opacity-30 animate-float w-[400px] h-[400px] bg-gradient-to-br from-[#0066ff] to-[#00ccff] bottom-[-150px] left-[-150px] animate-delay-5000"
      >
      </div>
    </div>

    <div
      class="bg-white rounded-none shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] p-8 sm:p-12 backdrop-blur-sm border-2 border-black w-full max-w-xl z-10"
    >
      <div id="step1">
        <div class="text-center mb-10">
          <h1 class="text-3xl font-bold text-gray-900 mb-2">
            Forgot Password?
          </h1>
          <p class="text-gray-500 text-sm">
            Enter your email and we'll send you an OTP to reset your password.
          </p>
        </div>

        <form class="space-y-6" id="requestOtpForm">
          <div class="flex flex-col gap-3">
            <label for="email" class="font-semibold text-sm text-gray-800"
              >Email Address</label
            >
            <div class="relative">
              <svg
                class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
                ></path>
                <polyline points="22,6 12,13 2,6"></polyline>
              </svg>
              <input
                type="email"
                id="email"
                name="email"
                class="w-full py-3 px-4 pl-12 border-2 border-black rounded-none text-base bg-gray-50
                transition-all duration-300 focus:border-blue-500 focus:outline-none focus:shadow-none
                font-bold"
                placeholder="name@company.com"
                required
                autocomplete="email"
              />
            </div>
          </div>

          <button
            type="submit"
            id="sendOtpBtn"
            class="w-full h-10 py-4 text-white font-bold text-md flex items-center justify-center gap-2
           bg-black border-2 border-black shadow-[4px_4px_0px_0px_rgba(147,51,234,1)] hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_rgba(147,51,234,1)] transition-all duration-300 rounded-none cursor-pointer uppercase tracking-wide"
          >
            <span>Send OTP</span>
            <svg
              class="w-5 h-5"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </form>
      </div>

      <div id="step2" class="hidden">
        <div class="text-center mb-10">
          <h1 class="text-3xl font-bold text-gray-900 mb-2">
            Reset Password
          </h1>
          <p class="text-gray-500 text-sm">
            Enter the OTP sent to your email and set a new password.
          </p>
        </div>

        <form class="space-y-6" id="resetPasswordForm">
          <input type="hidden" id="resetEmail" name="email" />

          <div class="flex flex-col gap-3">
            <label for="otp" class="font-semibold text-sm text-gray-800"
              >OTP Code</label
            >
            <div class="relative">
              <svg
                class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
              <input
                type="text"
                id="otp"
                name="otp"
                class="w-full py-3 px-4 pl-12 border-2 border-black rounded-none text-base bg-gray-50
                transition-all duration-300 focus:border-blue-500 focus:outline-none focus:shadow-none
                font-bold tracking-[0.5em] text-center"
                placeholder="000000"
                maxlength="6"
                required
                autocomplete="one-time-code"
              />
            </div>
          </div>

          <div class="flex flex-col gap-3">
            <label for="password" class="font-semibold text-sm text-gray-800"
              >New Password</label
            >
            <div class="relative">
              <svg
                class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
              <input
                type="password"
                id="password"
                name="password"
                class="w-full py-3 px-4 pl-12 border-2 border-black rounded-none text-base bg-gray-50
                transition-all duration-300 focus:border-blue-500 focus:outline-none focus:shadow-none
                font-bold"
                placeholder="Enter new password"
                required
                minlength="6"
                autocomplete="new-password"
              />
            </div>
          </div>

          <button
            type="submit"
            id="resetPasswordBtn"
            class="w-full h-10 py-4 text-white font-bold text-md flex items-center justify-center gap-2
           bg-black border-2 border-black shadow-[4px_4px_0px_0px_rgba(147,51,234,1)] hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_rgba(147,51,234,1)] transition-all duration-300 rounded-none cursor-pointer uppercase tracking-wide"
          >
            <span>Reset Password</span>
            <svg
              class="w-5 h-5"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            </svg>
          </button>

          <button
            type="button"
            id="backToStep1"
            class="w-full h-10 py-4 text-black font-bold text-md flex items-center justify-center gap-2
           bg-white border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] hover:translate-y-[2px] hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all duration-300 rounded-none cursor-pointer uppercase tracking-wide"
          >
            <span>‚Üê Back</span>
          </button>
        </form>
      </div>

      <div class="text-center mt-6 pt-6 border-t border-gray-300">
        <p class="text-gray-500 text-sm">
          Remember your password?
          <a
            href="/login"
            class="text-blue-800 font-semibold hover:text-blue-700 cursor-pointer"
            >Back to Login</a
          >
        </p>
      </div>
    </div>
  </main>

  <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

  <Footer />
</Layout>

<script>
  import api from "../lib/api";

  function showToast(message: string, type: "success" | "error" = "success") {
    const container = document.getElementById("toast-container");
    if (!container) return;

    const toast = document.createElement("div");
    toast.className = `p-4 rounded-none border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transform transition-all duration-300 ${
      type === "success" ? "bg-green-500 text-white" : "bg-red-500 text-white"
    } font-bold`;
    toast.textContent = message;

    container.appendChild(toast);

    setTimeout(() => {
      toast.style.opacity = "0";
      toast.style.transform = "translateX(400px)";
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  const step1 = document.getElementById("step1");
  const step2 = document.getElementById("step2");
  const requestOtpForm = document.getElementById("requestOtpForm");
  const resetPasswordForm = document.getElementById("resetPasswordForm");
  const backToStep1Btn = document.getElementById("backToStep1");

  let userEmail = "";

  requestOtpForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const emailInput = document.getElementById("email") as HTMLInputElement;
    const email = emailInput?.value?.trim();

    if (!email) {
      showToast("Please enter your email", "error");
      return;
    }

    const btn = document.getElementById("sendOtpBtn");
    if (btn) btn.innerHTML = '<span class="loading loading-spinner"></span> Sending...';

    try {
      const response = await api.post("/api/auth/forgot-password", { email });
      
      showToast(response.data.message || "OTP sent to your email!", "success");
      userEmail = email;
      
      step1?.classList.add("hidden");
      step2?.classList.remove("hidden");
      
      const resetEmailInput = document.getElementById("resetEmail") as HTMLInputElement;
      if (resetEmailInput) resetEmailInput.value = email;
    } catch (error: any) {
      const message = error.response?.data?.message || "Failed to send OTP";
      showToast(message, "error");
    } finally {
      if (btn) btn.innerHTML = '<span>Send OTP</span><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>';
    }
  });

  resetPasswordForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const otp = (document.getElementById("otp") as HTMLInputElement)?.value?.trim();
    const password = (document.getElementById("password") as HTMLInputElement)?.value;

    if (!otp || otp.length !== 6) {
      showToast("Please enter a valid 6-digit OTP", "error");
      return;
    }

    if (!password || password.length < 6) {
      showToast("Password must be at least 6 characters", "error");
      return;
    }

    const btn = document.getElementById("resetPasswordBtn");
    if (btn) btn.innerHTML = '<span class="loading loading-spinner"></span> Resetting...';

    try {
      const response = await api.post("/api/users/password/reset", {
        email: userEmail,
        otp,
        password,
      });
      
      showToast(response.data.message || "Password reset successfully!", "success");
      
      setTimeout(() => {
        window.location.href = "/login";
      }, 1500);
    } catch (error: any) {
      const message = error.response?.data?.message || "Failed to reset password";
      showToast(message, "error");
    } finally {
      if (btn) btn.innerHTML = '<span>Reset Password</span><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>';
    }
  });

  backToStep1Btn?.addEventListener("click", () => {
    step2?.classList.add("hidden");
    step1?.classList.remove("hidden");
  });
</script>

<style>
  @keyframes float {
    0%,
    100% {
      transform: translate(0, 0) scale(1);
    }
    33% {
      transform: translate(30px, -30px) scale(1.1);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .animate-float {
    animation: float 20s infinite ease-in-out;
  }
  .animate-delay-5000 {
    animation-delay: 5s;
  }
</style>
