---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
import jwt from "jsonwebtoken";

const token = Astro.cookies.get("token")?.value;
let user = null;
let isCompletionMode = false;

if (token) {
  try {
    const decoded = jwt.decode(token);
    if (decoded) {
      user = decoded;
      isCompletionMode = true;
    }
  } catch (e) {
    console.error("Invalid token", e);
  }
}

if (!token) {
    return Astro.redirect("/signup");
}
---

<Layout title="Register - EventEase">
  <Navbar />
  <main class="min-h-screen bg-white flex items-center justify-center px-8 py-12">
    <div class="w-full max-w-4xl">
      <div class="mb-8">
        <h1 class="text-3xl font-black text-gray-900 mb-2" style="font-family: 'Poppins', sans-serif;">
          {isCompletionMode ? "Complete your profile" : "Create your EventEase account"}
        </h1>
        <p class="text-gray-500 font-bold">One question at a time â€” fast and simple.</p>
      </div>

      <form id="registerForm" action="http://localhost:3000/api/user/update" method="POST">
          <input type="hidden" name="role" id="hiddenRole" value="" />
          <input type="hidden" name="email" value={user?.email} />
          <!-- PUT method override if needed by backend framework, though here we use POST to update endpoint -->
          <input type="hidden" name="_method" value="PUT" />

        <div class="flex items-center gap-4 mb-8">
          <div class="flex-1 bg-gray-200 h-3 overflow-hidden">
            <div id="progressBar" class="h-full bg-blue-600 transition-all duration-300" style="width:0%"></div>
          </div>
          <div class="text-base font-black text-gray-600">
            Step <span id="currentStep">1</span> of <span id="totalSteps">1</span>
          </div>
        </div>

        <div class="min-h-[400px]">
            <section class="tf-slide hidden" data-step="1" data-role="all">
              <h2 class="text-3xl font-black text-gray-900 mb-6">Are you creating an account as an organizer or attendee?</h2>
              <div class="flex flex-col gap-4">
                <label class="bg-gray-100 p-6 cursor-pointer hover:bg-blue-600 hover:text-white transition-all">
                  <div class="flex items-start gap-3">
                    <input type="radio" name="newRole" value="ORGANIZER" class="mt-1" />
                    <div>
                      <div class="font-black">Organizer</div>
                      <div class="text-sm font-semibold">Create and manage events</div>
                    </div>
                  </div>
                </label>
                <label class="bg-gray-100 p-4 cursor-pointer hover:bg-blue-600 hover:text-white transition-all">
                  <div class="flex items-start gap-3">
                    <input type="radio" name="newRole" value="USER" class="mt-1" />
                    <div>
                      <div class="font-black">Attendee</div>
                      <div class="text-sm font-semibold">Find and join events</div>
                    </div>
                  </div>
                </label>
              </div>
            </section>

            <section class="tf-slide hidden" data-step="2" data-role="ORGANIZER">
              <h2 class="text-3xl font-black text-gray-900 mb-6">What's your organization or group called?</h2>
              <input type="text" name="organization" class="w-full px-6 py-4 bg-gray-100 text-xl font-semibold focus:bg-blue-50 focus:outline-none" placeholder="Organization name" />
            </section>

            <section class="tf-slide hidden" data-step="3" data-role="ORGANIZER">
              <h2 class="text-3xl font-black text-gray-900 mb-6">Website (optional)</h2>
              <input type="url" name="organization_website" class="w-full px-6 py-4 bg-gray-100 text-xl font-semibold focus:bg-blue-50 focus:outline-none" placeholder="https://example.com" />
            </section>

            <section class="tf-slide hidden" data-step="4" data-role="ORGANIZER">
              <h2 class="text-3xl font-black text-gray-900 mb-6">Organization contact number</h2>
              <input type="tel" name="organization_phone" class="w-full px-6 py-4 bg-gray-100 text-xl font-semibold focus:bg-blue-50 focus:outline-none" placeholder="+1 (555) 000-0000" />
            </section>

            <!-- Skipped Name/Email/Password steps as they are already collected -->

            <section class="tf-slide hidden" data-step="8" data-role="USER">
              <h2 class="text-3xl font-black text-gray-900 mb-6">Phone number (optional)</h2>
              <input type="tel" name="phone" class="w-full px-6 py-4 bg-gray-100 text-xl font-semibold focus:bg-blue-50 focus:outline-none" placeholder="+1 (555) 000-0000" />
            </section>

            <section class="tf-slide hidden" data-step="10" data-role="all">
              <h2 class="text-3xl font-black text-gray-900 mb-6">Terms and conditions</h2>
              <div class="flex items-start gap-4">
                <input type="checkbox" name="terms" required class="mt-1 w-5 h-5" />
                <label class="text-gray-700 font-bold text-lg">I agree to the <a href="#terms" class="text-blue-600 font-black hover:underline">Terms of Service</a> and <a href="#privacy" class="text-blue-600 font-black hover:underline">Privacy Policy</a></label>
              </div>
            </section>

            <section class="tf-slide hidden" data-step="11" data-role="all">
              <h2 class="text-3xl font-black text-gray-900 mb-6">Ready to finish?</h2>
              <p class="text-gray-600 font-bold text-lg mb-8">Review your answers and complete your profile.</p>
            </section>
          </div>

        <div class="flex justify-between gap-3 mt-8">
          <button type="button" id="btnPrev" class="px-8 py-3 bg-gray-200 text-gray-900 font-black hover:bg-gray-300 transition-colors">Previous</button>
          <button type="button" id="btnNext" class="px-8 py-3 bg-blue-600 text-white font-black hover:bg-blue-700 transition-colors">Next</button>
          <button type="submit" id="btnSubmit" class="hidden px-8 py-3 bg-blue-600 text-white font-black hover:bg-blue-700 transition-colors">Complete Registration</button>
        </div>
      </form>
      
    </div>
  </main>
  <Footer />
</Layout>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .tf-slide:not(.hidden) {
    animation: fadeIn 0.3s ease;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const allSlides = Array.from(document.querySelectorAll('.tf-slide'));
  const progressBar = document.getElementById('progressBar');
  const currentStepEl = document.getElementById('currentStep');
  const totalStepsEl = document.getElementById('totalSteps');
  const hiddenRole = document.getElementById('hiddenRole');
  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');
  const btnSubmit = document.getElementById('btnSubmit');
  const form = document.getElementById('registerForm');

  let role = '';
  let visibleSlides = [];
  let currentIndex = 0;

  function buildVisibleSlides(selectedRole) {
    const sorted = allSlides.slice().sort((a, b) => Number(a.dataset.step) - Number(b.dataset.step));
    visibleSlides = sorted.filter(s => {
      const r = s.dataset.role;
      return r === 'all' || (selectedRole && r === selectedRole) || (r === 'USER' && selectedRole === 'USER') || (r === 'ORGANIZER' && selectedRole === 'ORGANIZER');
    });
    if (totalStepsEl) totalStepsEl.textContent = String(visibleSlides.length);
    if (currentIndex >= visibleSlides.length) currentIndex = visibleSlides.length - 1;
    showSlide(currentIndex);
  }

  function showSlide(index) {
    allSlides.forEach(s => s.classList.add('hidden'));
    const slide = visibleSlides[index];
    if (!slide) return;
    slide.classList.remove('hidden');
    
    if (currentStepEl) currentStepEl.textContent = String(index + 1);
    const total = visibleSlides.length;
    const pct = total > 1 ? Math.round((index / (total - 1)) * 100) : 0;
    if (progressBar) progressBar.style.width = pct + '%';

    const isFirst = index === 0;
    const isLast = index === total - 1;
    
    if (btnPrev) btnPrev.style.display = isFirst ? 'none' : 'block';
    if (btnNext) btnNext.style.display = isLast ? 'none' : 'block';
    if (btnSubmit) btnSubmit.style.display = isLast ? 'block' : 'none';
  }

  function validateCurrent() {
    const slide = visibleSlides[currentIndex];
    if (!slide) return true;
    const requireds = slide.querySelectorAll('[required]');
    for (const el of requireds) {
      if (el.type === 'checkbox') {
        if (!el.checked) { el.focus(); return false; }
      } else if (!el.value.trim()) { el.focus(); return false; }
    }
    return true;
  }

  function next() {
    if (!validateCurrent()) return;
    if (currentIndex < visibleSlides.length - 1) {
      currentIndex++;
      showSlide(currentIndex);
    }
  }

  function prev() {
    if (currentIndex > 0) {
      currentIndex--;
      showSlide(currentIndex);
    }
  }

  const roleRadios = document.querySelectorAll('input[name="newRole"]');
  roleRadios.forEach(r => r.addEventListener('change', (e) => {
    role = e.target.value;
    hiddenRole.value = role;
    buildVisibleSlides(role);
    if (currentIndex === 0) {
      currentIndex = 1;
      showSlide(currentIndex);
    }
  }));

  if (btnNext) btnNext.addEventListener('click', next);
  if (btnPrev) btnPrev.addEventListener('click', prev);
  if (btnSubmit && form) btnSubmit.addEventListener('click', (e) => {
      e.preventDefault();
    if (validateCurrent()) {
        // Handle form submission via fetch to support PUT method if needed, or just submit
        // Since we are using a standard form submit to a POST endpoint that handles updates, 
        // we can just submit.
        form.submit();
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const active = document.activeElement;
      if (active && active.tagName !== 'TEXTAREA' && hiddenRole.value) {
        e.preventDefault();
        next();
      }
    }
  });

  buildVisibleSlides('');
});
</script>
