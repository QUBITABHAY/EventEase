---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
---

<Layout title="Verify OTP - EventEase">
    <Navbar />
    <main
        class="relative min-h-screen flex items-center justify-center p-8 bg-gradient-to-br from-[#e8f4ff] to-[#f0f9ff] overflow-hidden"
    >
        <div class="absolute top-0 left-0 right-0 bottom-0 overflow-hidden z-0">
            <div
                class="absolute rounded-full filter blur-[100px] opacity-30 animate-float w-[500px] h-[500px] bg-gradient-to-br from-[#002ffe] to-[#000000] top-[-200px] right-[-200px]"
            >
            </div>
            <div
                class="absolute rounded-full filter blur-[100px] opacity-30 animate-float w-[400px] h-[400px] bg-gradient-to-br from-[#0066ff] to-[#00ccff] bottom-[-150px] left-[-150px] animate-delay-5000"
            >
            </div>
        </div>

        <div
            class="bg-white rounded-none shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] p-12 backdrop-blur-sm border-2 border-black w-full max-w-md relative z-10"
        >
            <div class="text-center mb-10">
                <h1 class="text-4xl font-bold text-gray-900 mb-2">
                    Verify OTP
                </h1>
                <p class="text-gray-500 text-sm">
                    Enter the OTP sent to your email
                </p>
            </div>

            <form id="otpForm" class="space-y-6">
                <div>
                    <label
                        for="email"
                        class="font-semibold text-sm text-gray-800">Email</label
                    >
                    <div class="relative mt-2">
                        <input
                            type="email"
                            id="email"
                            name="email"
                            class="w-full py-3 px-4 border-2 border-black rounded-none text-base bg-gray-50 transition-all duration-300 focus:border-blue-500 focus:outline-none focus:shadow-none font-bold"
                            placeholder="name@company.com"
                            required
                            autocomplete="email"
                        />
                    </div>
                </div>

                <div>
                    <label for="otp" class="font-semibold text-sm text-gray-800"
                        >OTP</label
                    >
                    <div class="relative mt-2">
                        <input
                            type="text"
                            id="otp"
                            name="otp"
                            class="w-full py-3 px-4 border-2 border-black rounded-none text-base bg-gray-50 transition-all duration-300 focus:border-blue-500 focus:outline-none focus:shadow-none font-bold text-center text-2xl tracking-widest"
                            placeholder="000000"
                            required
                            maxlength="6"
                            pattern="[0-9]{6}"
                        />
                    </div>
                </div>

                <button
                    type="submit"
                    class="w-full h-10 py-4 text-white font-bold text-md flex items-center justify-center gap-2 bg-black border-2 border-black shadow-[4px_4px_0px_0px_rgba(147,51,234,1)] hover:translate-y-[2px] hover:shadow-[2px_2px_0px_0px_rgba(147,51,234,1)] transition-all duration-300 rounded-none cursor-pointer uppercase tracking-wide"
                >
                    <span>Verify OTP</span>
                </button>
            </form>

            <div class="text-center mt-6 pt-6 border-t border-gray-300">
                <p class="text-gray-500 text-sm">
                    Didn't receive OTP? <a
                        href="/signup"
                        class="text-blue-800 font-semibold hover:text-blue-700 cursor-pointer"
                        >Sign up again</a
                    >
                </p>
            </div>
        </div>
    </main>
    <Footer />
</Layout>

<!-- Toast Notification Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2">
</div>

<style>
    @keyframes float {
        0%,
        100% {
            transform: translate(0, 0) scale(1);
        }
        33% {
            transform: translate(30px, -30px) scale(1.1);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .animate-float {
        animation: float 20s infinite ease-in-out;
    }
    .animate-delay-5000 {
        animation-delay: 5s;
    }
</style>

<script>
    import api from "../lib/api";

    // Toast notification function
    function showToast(message: string, type: "success" | "error" = "success") {
        const container = document.getElementById("toast-container");
        if (!container) return;

        const toast = document.createElement("div");
        toast.className = `p-4 rounded-none border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transform transition-all duration-300 ${
            type === "success"
                ? "bg-green-500 text-white"
                : "bg-red-500 text-white"
        } font-bold`;
        toast.textContent = message;

        container.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = "0";
            toast.style.transform = "translateX(400px)";
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function initOtpVerification() {
        const otpForm = document.getElementById("otpForm");
        console.log("OTP form:", otpForm);

        if (!otpForm) {
            console.error("OTP form not found!");
            return;
        }

        otpForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            console.log("OTP form submitted");

            const formData = new FormData(e.target as HTMLFormElement);
            const data = Object.fromEntries(formData.entries());

            console.log("Sending OTP verification request...", {
                email: data.email,
            });

            try {
                const response = await api.post(
                    "/api/auth/local/verify-otp",
                    data,
                );
                const result = response.data;
                console.log(
                    "OTP verification response:",
                    response.status,
                    result,
                );

                if (response.status === 201 && result.requiresProfile) {
                    showToast(
                        result.message ||
                            "OTP verified! Please complete your profile.",
                        "success",
                    );
                    setTimeout(() => {
                        window.location.href = "/completeprofile";
                    }, 1000);
                }
            } catch (error) {
                console.error("OTP verification error:", error);
                const message =
                    error.response?.data?.message ||
                    "Invalid OTP. Please try again.";
                showToast(message, "error");
            }
        });
    }

    // Ensure DOM is loaded before attaching event listeners
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initOtpVerification);
    } else {
        initOtpVerification();
    }

    // Make showToast globally available
    (window as any).showToast = showToast;
</script>
